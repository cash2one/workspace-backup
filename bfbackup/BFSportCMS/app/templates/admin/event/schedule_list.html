<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>暴风体育内容管理系统 - CMS</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.5 -->
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <!-- jQuery UI -->
    <link rel="stylesheet" href="/static/plugins/jQueryUI/jquery-ui.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="/static/plugins/datatables/dataTables.bootstrap.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/bootstrap/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="/static/bootstrap/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="/static/dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="/static/dist/css/skins/_all-skins.min.css">
    <link rel="stylesheet" href="/static/calendarPicker/jquery.calendarPicker.css">
    <link rel="stylesheet" href="/static/jquery.datetimepicker.css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .table tbody tr td {
            vertical-align: middle;
        }

        .ui-dialog-titlebar-close {
            outline: none;
        }

        .box-info .col-md-12 {
            padding: 0;
            margin: 0 auto;
        }

        body {
            overflow: auto
        }

        .content .box.box-info {
            overflow: auto;
        }

        #tip {
            word-break: break-all;
            word-wrap: break-word;
        }

        .box-title {
            margin: 20px auto;
            padding-left: 20px;
        }

        .table-list td img {
            width: 20px;
            height: 20px;
        }

        .box-info .col-md-12 .table.table-list th,
        .box-info .col-md-12 .table.table-list td {
            text-align: center
        }

        .select-date {
            text-align: center;
        }

        .schedule {
            width: 765px;
            height: 100px;
            padding: 20px 30px;
            margin: 0 auto;
            border: 1px solid #f1f1f1;
        }

        #fixture_list {
            width: 705px;
            margin: 0 auto;
        }

        #fixture_list a.prev,
        #fixture_list a.next {
            width: 20px;
            height: 60px;
            line-height: 60px;
            text-align: center;
            float: left;
        }

        #photo {
            width: 665px;
            height: 60px;
            float: left;
            position: relative;
            overflow: hidden
        }

        #photo_panel {
            height: 60px;
        }

        #photo_panel {
            position: absolute;
        }

        .photo_panel ul {
            float: left;
            list-style-type: none;
            padding: 0;
            margin: 0
        }

        .photo_panel ul li {
            width: 95px;
            height: 60px;
            float: left;
        }

        .photo_panel ul li a {
            display: block;
            width: 85px;
            height: 60px;
            margin: 0 auto;
            text-align: center;
            background: #f9fafc;
            border: 1px solid #f5f5f5;
            line-height: 28px;
        }

        .photo_panel ul li a.active {
            background: #00c0ef;
            border: 1px solid #00acd6;
            color: #ffffff;
        }

        #table-list i{ font-style: normal;}

        #table-list td,
        #table-list th {
            font-size: 12px;;
            height: 20px;
            padding: 4px;
        }
        #table-list td.against{width:310px; overflow: hidden;}
        #table-list td table,
        #table-list th table{ margin: 0 auto;}

        #table-list td table td span,
        #table-list th table th span{display: block;width:150px; text-align: center;}
        #table-list td table td input{width:148px;}

        #table-list td table td:nth-child(1) select{width:145px;}
        #table-list td table td:nth-child(2) span,
        #table-list th table th:nth-child(2) span,
        #table-list td table td:nth-child(2) input{width:92px;}

        #table-list td table td:nth-child(3) span,
        #table-list td table td:nth-child(4) span,
        #table-list td table td:nth-child(5) span,
        #table-list td table td:nth-child(6) span,
        #table-list th table th:nth-child(3) span,
        #table-list th table th:nth-child(4) span,
        #table-list th table th:nth-child(5) span,
        #table-list th table th:nth-child(6) span{width:138px;  display: block; }

        #table-list td table td:nth-child(3) input,
        #table-list td table td:nth-child(4) input,
        #table-list td table td:nth-child(5) input,
        #table-list td table td:nth-child(6) input,
        #table-list th table th:nth-child(3) input,
        #table-list th table th:nth-child(4) input,
        #table-list th table th:nth-child(5) input,
        #table-list th table th:nth-child(6) input{width:138px;  display: block; word-break:break-all;white-space:pre-wrap;}

        #table-list td.add_del a,
        #table-list td.against a,
        #table-list td.addition a{margin-bottom: 5px;}
        .form-control {
            width: auto;
            height: 26px;
            display: inline;
        }
        .operation a{display: block; margin-bottom: 5px;}
        /*.add_del i{display: block;}*/
        .content-wrapper{z-index: 0;}
        .modal-body{word-break:break-all;white-space:pre-wrap;}
    </style>
</head>
<body class="hold-transition skin-blue sidebar-mini" style="background: #ecf0f5;">
<div class="wrapper">

    <div class="content-wrapper col-md-12" style="margin-left: 0;">
        <section class="content-header">
            <h1><i class="fa fa-tags"></i>暴风体育CMS</h1>
        </section>
        <section class="content">
            <div class="row  box box-info">
                <div class="box-body nopadding">
                    <div class="col-md-3 col-md-offset-9">
                        <!--<a href="/event/{{event_id}}/schedules/add" role="button" id="add-channel-btn" href="" class="btn btn-success btn-flat pull-right"><i class="glyphicon glyphicon-plus"></i>-->
                        <!--添加赛程</a>暂时隐藏此按钮-->
                    </div>
                </div>
                <h4 class="box-title select-date">选择日期</h4>
                <div class="schedule">
                    <div id="fixture_list">
                        <a href="javascript:void('prev');" class="prev">
                            <span class="prev_span">&lt;</span>
                        </a>

                        <div id="photo" class="photo">
                            <div id="photo_panel" class="photo_panel">
                                <ul>
                                    {% for schedule in schedules %}
                                    <li>
                                        <a class="active" id="{{schedule['id']}}"
                                           href="/event/schedules?event_id={{event_id}}&date={{ schedule['id'] }}">
                                            {{schedule['date'][0]}} <br/>
                                            {{schedule['date'][1]}}
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <a href="javascript:void('prev');" class="next">
                            <span class="next_span">&gt;</span>
                        </a>
                    </div>
                </div>
                <div style="clear: both"></div>
                <h4 class="box-title" id="curreDate"></h4>

                <div class="col-md-12">
                    <table class="table table-hover table-list" id="table-list">
                        <thead>
                        <tr>
                            <th>比赛ID</th>
                            <th>赛事ID</th>                            
                            <th>时间</th>
                            <th>比赛状态</th>
                            <th>轮次</th>
                            <th>对阵双方</th>
                            <th>
                                <table cellpadding="0" cellspacing="0">
                                    <tr>
                                        <th><span>直播源</span></th>
                                        <th><span>切流时间</span></th>
                                        <th><span>直播源地址(playUrl)</span></th>
                                        <th><span>播放代码(playHtml)</span></th>
                                        <th><span>推流参数(feedCode)</span></th>
                                        <th><span>自有直播地址(playCode)</span></th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </table>
                            </th>

                            <th>操作</th>
                        </tr>
                        </thead>

                        <tbody>

                     {% for match in matches %}
                            {% if match %}

                        <tr>
                            <td>{{match.id }}</td>
                            <td>{{event_id }}</td>
                            <td>{{match.start_tm | to_date }}</td>
                                {% if match.status == 'notstarted' %}
                                <td>未开始</td>
                                {% elif  match.status == 'ongoing' %}
                                <td>进行中</td>                            
                                 {% else %}                               
                                <td>已结束</td>                                 
                                {% endif %}
                            <td>{{match.brief}}</td>
                            <td class="against"><img src="{{match.team1.badge}}"><span>&nbsp;{{match.team1.name}}&nbsp;&nbsp; {{match.team1.score}} -- {{match.team2.score}} &nbsp;&nbsp;{{match.team2.name}}</span><img src="{{match.team2.badge}}"></td>

                            <td class="all">
                                <table>

                               {% if match['live_play_urls'] %}

                                 {% for live in match['live_play_urls'] %}
                                    <tr>
                                        <td>
                                            <span>
                                                <i>{{live['site']}}</i>

                                                <select style="display: none" class="form-control" value="{{live['site']}}" name='site'>
                                                    {% for site in sites %}
                                                    <option value="{{site.site}}" {% if site.site== live['site']
                                                     %} selected="selected" {% endif %}>{{site.live_title}}-{{site.site}}</option>
                                                    {% endfor %}
                                                </select>
                                            </span>
                                        </td>
                                        <td>
                                            <input type="text" style="display: none" name="stream_time" value="" placeholder="点击选择时间" class="datetimepicker">
                                            <!--时间输入到下面的span里-->
                                            <span>{{live['stream_time']}}</span>
                                        </td>
                                        <td title="直播源地址">
                                            <!--<span>{{live['play_url']}}</span>-->
                                            <input type="text" style="display: none" value="{{live['play_url']}}">
                                            <span>
                                                <button name="modaldialog"  class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal" data-text="{{live['play_url']}}">查看</button>   </span>
                                            <!-- /.modal -->
                                        </td>
                                        <td title="播放代码">
                                            <!--<span>{{live['play_html']}}</span>-->
                                            <input type="text" style="display: none" value="{{live['play_html']}}">
                                                                                        <!-- Button trigger modal -->
                                            <span>
                                                <button name="modaldialog" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal" data-text="{{live['play_html']}}">查看</button>

                                            </span>
                                        </td>
                                        <td title="推流参数">
                                            <!--<span>{{live['feed_code']}}</span>-->
                                            <input type="text" style="display: none" value="{{live['feed_code']}}">
                                            <!-- Button trigger modal -->
                                            <span><button name="modaldialog" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal" data-text="{{live['feed_code']}}">查看</button>
                                            </span>
                                            <!-- /.modal -->
                                        </td>
                                        <td title="自有直播地址">
                                            <!--<span>{{live['play_code']}}</span>-->
                                            <input type="text" style="display: none" value="{{live['play_code']}}">
                                            <!-- Button trigger modal -->
                                            <span><button name="modaldialog" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal" data-text="{{live['play_code']}}">查看</button>
                                            </span>
                                            <!-- /.modal -->
                                        </td>
                                        <td class="add_del">
                                            <a href=""  name="plus-source" style="display: none" type="button" class="btn btn-xs btn-danger" data-tid=""><i class="fa fa-fw fa-plus" title=""></i></a>
                                            <a href="" name="minus-source" style="display: none" type="button" class="btn btn-xs btn-info" data-tid=""><i class="fa fa-fw fa-minus" title=""></i></a>
                                        </td>

                                        <td class="addition">
                                            <a style="display: none" href="" name="apply" type="button" class="btn btn-xs btn-info" data-tid=""><i
                                                    class="fa fa-fw fa-desktop" title=""></i> <i>申请直播</i></a>
                                            <a style="display: none" href="" name="release" type="button" class="btn btn-xs btn-info" data-tid=""><i
                                                    class="fa fa-fw fa-share" title=""></i> <i>发布信息</i></a>
                                        </td>

                                    </tr>
                            {% endfor %}

                            {% else %}
                                    <tr>
                                        <td>
                                            <span>
                                                <i></i>
                                                <select style="display: none" class="form-control" value="defaut" name='site'>
                                                    <option value="default">请选择直播源</option>
                                                    {% for site in sites %}
                                                    <option value="{{site.site}}">{{site.live_title}}</option>
                                                    {% endfor %}
                                                </select>
                                            </span>
                                        </td>
                                        <td>
                                            <input type="text" style="display: none" name="stream_time" value="" placeholder="点击选择时间" class="datetimepicker">
                                            <span></span>
                                        </td>
                                        <td>
                                            <input type="text" style="display: none" value="">
                                            <!-- Button trigger modal -->
                                            <span><button name="modaldialog" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal" data-text="">查看</button>
                                            </span>
                                            <!-- /.modal -->
                                        </td>
                                        <td>
                                            <input type="text" style="display: none" value="">
                                            <!-- Button trigger modal -->
                                            <span><button name="modaldialog" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal" data-text="">查看</button>
                                            </span>
                                            <!-- /.modal -->
                                        </td>
                                        <td>
                                            <input type="text" style="display: none" value="">
                                            <!-- Button trigger modal -->
                                            <span><button name="modaldialog" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal" data-text="">查看</button>
                                            </span>
                                            <!-- /.modal -->
                                        </td>
                                        <td>
                                            <input type="text" style="display: none" value="">
                                            <!-- Button trigger modal -->
                                            <span><button name="modaldialog" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal" data-text="">查看</button>
                                            </span>
                                            <!-- /.modal -->
                                        </td>
                                        <td class="add_del">
                                            <a href=""  name="plus-source" style="display: none" type="button" class="btn btn-xs btn-danger" data-tid=""><i class="fa fa-fw fa-plus" title=""></i></a>
                                            <a href="" name="minus-source" style="display: none" type="button" class="btn btn-xs btn-info" data-tid=""><i class="fa fa-fw fa-minus" title=""></i></a>
                                        </td>
                                        <td class="addition">
                                            <a style="display: none" href="" name="apply" type="button" class="btn btn-xs btn-info" data-tid=""><i
                                                    class="fa fa-fw fa-desktop" title=""></i> <i>申请直播</i></a>
                                            <a style="display: none" href="" name="release" type="button" class="btn btn-xs btn-info" data-tid=""><i
                                                    class="fa fa-fw fa-share" title=""></i> <i>发布信息</i></a>
                                        </td>
                                    </tr>
                            {% endif %}
                                </table>
                            </td>

                            <td class='operation'>
                                <a href="" name="editor" type="button" class="btn btn-xs btn-success" data-tid=""><i
                                        class="fa fa-fw fa-edit" title=""></i> 编辑视频源</a>
                                <a style="display: none;" href="" name="submit" type="button" class="btn btn-xs btn-danger" data-tid=""><i
                                        class="fa fa-fw fa-check" title=""></i> 提交更改</a>
                            </td>
                        </tr>

                        {% endif %}
                        {% endfor %}


                        </tbody>
                    </table>
                </div>
            </div>

        </section>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">详情</h4>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--后台在这里在输出一边直播源-->
<div id="live_soure" style="display: none">
    <select class="form-control" value="default" name='site'>
        <option value="default">请选择直播源</option>
        {% for site in sites %}
        <option value="{{site.site}}">{{site.live_title}}-{{site.site}}</option>
        {% endfor %}
    </select>
</div>

<div id="tip" style="display: none" title="提示">
    <p class="tip-info"></p>
</div>

<div id="del_tip" style="display: none" title="提示">
    <p class="del-info">您确定要删除此条赛程?</p>
</div>

<div id="del_tip_soure" style="display: none" title="提示">
    <p class="del-info-soure">您确定要删除此条直播源?<br>删除或编辑后请<strong style="color: #ff0000">重新提交更改</strong>,方可生效!</p>
</div>

<div id="tip_sucsses" title="信息提示">
    <p class="">操作成功</p>
</div>

<!-- jQuery 2.1.4 -->
<script src="/static/plugins/jQuery/jQuery-2.1.4.min.js"></script>
<!-- Bootstrap 3.3.5 -->
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<!-- jQuery UI -->
<script src="/static/plugins/jQueryUI/jquery-ui.min.js"></script>
<!-- DataTables -->
<script src="/static/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/static/plugins/datatables/dataTables.bootstrap.min.js"></script>
<script src="/static/slideShow.js"></script>
<script src="/static/jquery.datetimepicker.full.js"></script>
<script>
//$.datetimepicker.setLocale('ch');{lang:'ch',//中文化}
$.each($('.datetimepicker'),function(i,data){
    $(data).datetimepicker();
});
$.datetimepicker.setLocale('ch');

    //验证提示
    var dialogTip = $('#tip').dialog({
        autoOpen: false,
//		height: auto,
        width: 350,
        modal: true
    });
    //删除整条数据提示
    var dialogDel = $('#del_tip').dialog({
        autoOpen: false,
//		height: auto,
        width: 350,
        modal: true
    });

    //删除数据源提示
    var dialogDelSoure = $('#del_tip_soure').dialog({
        autoOpen: false,
//		height: auto,
        width: 350,
        modal: true
    });

    //操作成功提示
    var dialogSuc = $('#tip_sucsses').dialog({
        autoOpen: false,
//		height: auto,
        width: 350,
        modal: true
    });

    function tdWidth(){
        $.each($("#table-list th table tr th"),function(i,dataTH){
            $.each($("#table-list td table tr td"),function(j,dataTD){
                if(j == i){
                    $(dataTH).width($(dataTD).width() + "px");
                }
                else{}
            });
        });
//        $("#table-list th table tr th:last").width($("#table-list td table tr td:last").width() + 8 + "px");
    }

    var liveSoureStr = $("#live_soure").html();//获取直播源select字符串;

    var strInsert = '<input style="display: none" type="text" style="" value=""><span><button name="modaldialog" style="display: none" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal">查看</button></span>';

    var strInsertAdd = '<input style="display: block" type="text" style="" value=""><span><button name="modaldialog" style="display: none" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal">查看</button></span>';

    //初始化插入字符串
    var insertStr = '';
    insertStr += '<tr>';
    insertStr += '<td>';
    insertStr += '<span>';
    insertStr += '<i></i>';
    insertStr += liveSoureStr;
    insertStr += '</span>';
    insertStr += '</td>';
    insertStr += '<td>';
    insertStr += '<input type="text" name="stream_time" value="" placeholder="点击选择时间" class="datetimepicker">';
    insertStr += '<span>';
    insertStr += '</span>';
    insertStr += '</td>';
    insertStr += '<td>'+strInsertAdd+'</td>';
    insertStr += '<td>'+strInsertAdd+'</td>';
    insertStr += '<td>'+strInsertAdd+'</td>';
    insertStr += '<td>'+strInsertAdd+'</td>';
    insertStr += '<td class="add_del">';
    insertStr += '<a href=""  name="plus-source" style="display: block" type="button" class="btn btn-xs btn-danger" data-tid=""><i class="fa fa-fw fa-plus" title=""></i></a>';
    insertStr += '<a href="" name="minus-source" style="display: block" type="button" class="btn btn-xs btn-info" data-tid=""><i class="fa fa-fw fa-minus" title=""></i></a>';
    insertStr += '</td>';

    insertStr += '<td class="addition">';
    insertStr += '<a style="display: none" href="" name="apply" type="button" class="btn btn-xs btn-info" data-tid=""><i class="fa fa-fw fa-desktop" title=""></i> <i>申请直播</i></a>';
    insertStr += '<a style="display: none" href="" name="release" type="button" class="btn btn-xs btn-info" data-tid=""><i class="fa fa-fw fa-share" title=""></i> <i>发布信息</i></a>';
    insertStr += '</td>';


    insertStr += '</tr>';

    var delnum = 0;

    var ownSourcesName = '暴风体育';//默认自有直播源字段
    var ownSourcesValue = 'bfonline';//默认自有直播源字段value

    //初始化每条数据是否是自由直播源
//    var intTrs = $("#table-list td table tr");
//    var intTrNums = intTrs.size();
//    for(i=0;i<intTrNums;i++){
//        if($(intTrs[i]).find("span:eq(0)").find("i").text() == ''){
//            $(intTrs[i]).find("span:eq(1)").find("i").text("");
//        }
//        else{
//            if($(intTrs[i]).find("span:eq(0)").find("i").text() == ownSourcesValue){
//                $(intTrs[i]).find("span:eq(1)").find("i").text("是");
//            }
//            else{
//                $(intTrs[i]).find("span:eq(1)").find("i").text("否");
//
//            }
//        }
//
//
//        $.each($(intTrs[i]).find("span button"),function(i,databutton){
//            if(databutton.name == "modaldialog"){
//                if($(databutton).data("text") == ""){
//                    $(databutton).hide()
//                }
//                else{
//                }
//            }
//            else{}
//        })
//    }

    //当选择直播源时,随动是否为自有直播源
    $("#table-list").on("change","select",function(){
        if(this.value == ownSourcesValue){
//            $(this).parent().parent().next().find("span").text("是");
            $($(this).parent().parent().parent().find("td:last").find("a")[0]).show();
            $($(this).parent().parent().parent().find("td:last").find("a")[1]).show();
        }
        else{
//            $(this).parent().parent().next().find("span").text("否");
            $($(this).parent().parent().parent().find("td:last").find("a")[0]).hide();
            $($(this).parent().parent().parent().find("td:last").find("a")[1]).hide();
        }
        tdWidth();
    })


    function toTXT(str) {
        var RexStr = /\<|\>|\"|\'|\&|　| /g
        str = str.replace(RexStr,
                function (MatchStr) {
                    switch (MatchStr) {
                        case "<":
                            return "&lt;";
                            break;
                        case ">":
                            return "&gt;";
                            break;
                        case "\"":
                            return "&quot;";
                            break;
                        case "'":
                            return "&#39;";
                            break;
                        case "&":
                            return "&amp;";
                            break;
                        case " ":
                            return "&ensp;";
                            break;
                        case "　":
                            return "&emsp;";
                            break;
                        default:
                            break;
                    }
                }
        )
        return str;
    }
    function ToHtmlString(htmlStr) {
        return toTXT(htmlStr).replace(/\&lt\;br[\&ensp\;|\&emsp\;]*[\/]?\&gt\;|\r\n|\n/g, "<br/>");
    }

    $("#table-list").on("click","button",function(){
        if(this.name == "modaldialog"){
            $("#myModal").find(".modal-body").text($(this).data("text"));
            $("#myModalLabel").text($(this).parent().parent().attr("title"))
        }
    });

    $("#table-list").on("click","a",function(e){
        e.preventDefault();
        //点击每条编辑的行为
        if(this.name == "editor"){
            //计算有几条直播源行
            var trNums = $(this).parent().prev().find("tr");
            var trLength = trNums.size();
            //将数据变为可编辑状态
            for(i=0;i<trLength;i++){
                $.each($(trNums[i]).find("span"),function(j,data){
                    if(j == 0){
                        $(data).find('i').text('');
                        $(data).find('select').show();
                    }
                    else if(j == 1){
                        $(data).hide();
                        $(data).parent().find('input').val($(data).text())
                        $(data).parent().find('input').show();
                        //此条分之不能删除
                    }
                    else{

//                        if(j == 4 || j == 5){
//                            //$(data).parent().find('span').hide();
//                            $(data).parent().find('button').hide();
//                            $(data).parent().find('input').show();
//                        }
//                        else{
                            //$(data).parent().find('span').hide();
                            $(data).parent().find('button').hide();
                            $(data).parent().find('input').show();
//                        }
                        //$(data).remove();
                    }
                });
            }
            //隐藏编辑按钮,显示提交按钮
            $(this).hide();
            $(this).parent().find("a:eq(1)").show();
            //显示每条数据后面的删除和添加按钮
            var addDels = $(this).parent().prev().find(".add_del").size();
            $.each($(this).parent().prev().find(".add_del"),function(i,data){
                //这里判断的是只有最后一行显示添加,其余数据源只显示删除按钮
                if((i+1) == addDels){
                    $(data).find("a:eq(0)").show();
                    $(data).find("a:eq(1)").show();
                }
                else{
                    $(data).find("a:eq(1)").show();
                }
//                $(data).find("a:eq(2)").hide();
//                $(data).find("a:eq(3)").hide();
            });

            //根据是否为暴风源显示发布按钮
            $.each($(this).parent().prev().find(".addition"),function(i,data){
                //这里判断的是只有最后一行显示添加,其余数据源只显示删除按钮

                if($(data).parent().find("td:eq(0)").find("span select").val() == ownSourcesValue){
                    $(data).find("a:eq(0)").show();
                    $(data).find("a:eq(1)").show();
                }
                else{
                    $(data).find("a:eq(0)").hide();
                    $(data).find("a:eq(1)").hide();
                }

            });

            //至少保证有1行tr,即少于等于一行tr,本行tr不进行删除操作
            var sources = $(this).parent().parent().parent().find("tr").size();
            if(sources == 1){
                if($(this).parent().parent().find("td")[0].text() == ''){
                    $(data).find("a:eq(1)").hide();
                }
                else{}
            }
            else{}
            tdWidth();
        }
        //点击每条提交的行为
        else if(this.name == "submit"){
            //计算有几条直播源行
            var trs = $(this).parent().prev().find("tr");
            var trLength = trs.size();
            var returnStatus;//初始化验证状态,true为验证通过,false为验证不通过
            var selectSouse;
            for(i=0;i<trLength;i++){
                //计算每行有几条数据
                var changeTds = $(trs[i]).find("td");
                var changeTdLength = changeTds.size();
                if(trLength == 1 && $(changeTds[0]).find("select").css("display") == "none"){
                    returnStatus = true;
                }
                else{
                    //验证数据
                    for(j=0;j<changeTdLength;j++){
                        //验证每条数据的第一个字段--直播源是否选择
                        //如果验证失败,立即跳出循环,并赋值changeTdLength用于检查是否跳出顶层循环
                        if(j == 0){
                            if($(changeTds[j]).find("select").val() == '' || $(changeTds[j]).find("select").val() == 'default'){
                                if(j == 0){
                                    //alert("请选择第" + (i+1) + "条数据源");
                                    dialogTip.dialog('open');
                                    $(".tip-info").text("请选择第" + (i+1) + "条数据的直播源");
                                    returnStatus = false;
                                    break;
                                }
                            }
                            else{
                                returnStatus = true;
                            }
                        }

                        else{
                            if($(changeTds[j]).find("input").val() == ""){
                                //验证每条数据的第3个字段--数据源地址是否填写
                                var selectSouse = $(trs[i]).find("td:eq(0)").find("select").val();
                                if($(trs[i]).find("td:eq(0)").find("select").val() != ownSourcesValue){
                                    if(j == 2){
                                        dialogTip.dialog('open');
                                        $(".tip-info").text("请填写第" + (i+1) + "条数据源是的地址(playUrl)");
                                        returnStatus = false;
                                        break;
                                    }
                                    else{}
                                }
                                else{
//                                    if(j == 4){
//                                        //验证每条数据的第5个字段--数据源推流参数是否填写
//                                        dialogTip.dialog('open');
//                                        $(".tip-info").text("请填写第" + (i+1) + "条数据源的推流参数(feedCode)");
//                                        returnStatus = false;
//                                        break;
//                                    }
//                                    else{}
                                    if(j == 5){
                                        //验证每条数据的第5个字段--数据源自有直播地址是否填写
                                        dialogTip.dialog('open');
                                        $(".tip-info").text("请填写第" + (i+1) + "条数据源的自有直播地址(playCode)");
                                        returnStatus = false;
                                        break;
                                    }
                                    else{}
                                }
                            }
                            else{
                                returnStatus = true;
                            }

                            //returnStatus = true;
                        }
                    }
                }

                if(returnStatus == false){break;}//如果验证不通过,跳出顶层循环
                else{
                    returnStatus = true;
                }
            }
            //验证通过,将input的值回写到每行的span或i标签内
            if(returnStatus == true){
                //计算有几条直播源行
                var trs = $(this).parent().prev().find("tr");
                var trLength = trs.size();
                var returnStatus;
                for(k=0;k<trLength;k++) {
                    //计算每行有几条数据
                    var changeTds = $(trs[k]).find("td");
                    var changeTdLength = changeTds.size();
                    for (h = 0; h < changeTdLength; h++) {
                        //第一条数据,将select的value赋值给i标签,并隐藏select
                        if(h == 0){
                            if(trLength == 1 && $(changeTds[0]).find("select").css("display") == "none"){
                                $($(changeTds[h]).find("i")).text("");
                                $($(changeTds[h]).find("select")).hide();
                                $($(changeTds[h]).find("i")).show();
                            }
                            else{
                                $($(changeTds[h]).find("i")).text($(changeTds[h]).find("select").val());
                                $($(changeTds[h]).find("select")).hide();
                                $($(changeTds[h]).find("i")).show();
                            }
                        }
                        //第二条,因为是选择的时候自动写入的,不做操作
                        else if(h == 1){
                            $(changeTds[h]).find("input").hide();
                            $(changeTds[h]).find("span").text($(changeTds[h]).find("input").val());
                            $(changeTds[h]).find("span").show();
                        }
                        //将最后一列增加删除隐藏
                        else if(h == (changeTdLength-2)){
                            $($(changeTds[h]).find("a")[0]).hide();
                            $($(changeTds[h]).find("a")[1]).hide();
                            $(this).hide();
                            $(this).parent().find("a:eq(0)").show();
                        }
                        else if(h == (changeTdLength-1)){
                            $($(changeTds[h]).find("a")[0]).hide();
                            $($(changeTds[h]).find("a")[1]).hide();
                        }
                        //将其余列的数据从input的value写入到span
                        else{
                            if(trLength == 1 && $(changeTds[0]).find("select").css("display") == "none" && $(changeTds[0]).find("i").text() == ""){
                                $(changeTds[h]).html(strInsert);
                            }
                            else{
                                $(changeTds[h]).find("input").hide();
                                $(changeTds[h]).find("span").show();
                                $(changeTds[h]).find("button").show();
                                //$(changeTds[h]).find("button").data("text",$(changeTds[h]).find("input")[0].value);
                                if($(changeTds[h]).find("input")[0].value){
                                    $(changeTds[h]).find("button").data("text",$(changeTds[h]).find("input")[0].value);
                                }
                                else{
                                    $(changeTds[h]).find("button").hide();
                                }
                            }

                        }
                    }
                }

                //隐藏提交按钮,显示编辑按钮
                $(this).hide();
                $(this).parent().find("a:eq(0)").show();
                //初始化发送给服务器的参数
                var sendJson = {
                    "id":"",
                    "allSources":[]
                }
                //计算几条数据
                sendJson.id = $(this).parent().parent().find("td:eq(0)").text();
                var sendSources = $(this).parent().prev().find("tr");
                var sendSourceLength = sendSources.size();
                for(i=0;i<sendSourceLength;i++){
                    //计算每条数据,有几项
                    var sendTdDatas = $(sendSources[i]).find("td");
                    var sendTdDataLength = sendTdDatas.size();
                    //构造数据
                    var tempData = {};
                    for(j=0;j<sendTdDataLength;j++){
                        if(j == 0){
                            tempData.sourcesName = $(sendTdDatas[j]).find("i").text();
                        }
                        else if(j == 1){
                            tempData.stream_time = $(sendTdDatas[j]).find("span").text();
//                            tempData.isOwn = $(sendTdDatas[j]).find("span").text();
                        }
                        else if(j == 2){
                            tempData.sourcesUrl = $(sendTdDatas[j]).find("input").val();
                        }
                        else if(j == 3){
                            tempData.playHtml  = $(sendTdDatas[j]).find("input").val();

                        }
                        else if(j == 4){
                            tempData.feedCode = $(sendTdDatas[j]).find("input").val();
                        }
                        else if(j == 5){
                            tempData.playCode  = $(sendTdDatas[j]).find("input").val();
                        }
                        else if(j == sendTdDataLength-1){}
                    }
                    sendJson.allSources.push(tempData);
                }

                var dataStr = {data : JSON.stringify(sendJson)};
                $.post("{{url_for('admin.add_lives')}}", dataStr,
                       function(data){
                            if (data.errno == 200) {
                                dialogDelSoure.dialog('close');
                                dialogSuc.dialog('open');
                                tip();
                            }
                            else {
                                dialogTip.dialog('open');
                                $(".tip-info").text(data.message);
                            }
                });
                //这里发送ajax请求
            }
            else{}
            tdWidth();
        }
        //点击每条添加直播源的行为
        else if(this.name == "plus-source"){
            var sources = $(this).parent().parent().parent().find("tr");
            var sourcesLength = sources.size();
            if(sourcesLength == 1){
                var tds = $(this).parent().parent().find("td");
                var tdNums = tds.size();
                if($(tds[2]).find('input').css("display") == "none"){
                    $.each(tds,function(i,data){
                        if(i==0){
                            $(data).find("select").show();
                            $(data).find("select").get(0).selectedIndex = 0;
                            $(data).find("i").hide();
                        }
                        else if(i == 1){
                            $(data).find("input").show();
                        }
                        else if(i == (tdNums - 1)){}
                        else if(i == (tdNums - 2)){
                            $(this).parent().find("a:eq(1)").show();
                        }
                        else if(i == 4 || i == 5){
                            $(data).find("input").show();
                        }
                        else{
                            $(data).find("input").show();
                        }
                    });

                }
                else{
                    $(this).parent().parent().parent().append(insertStr);
                    for(i=0;i<sourcesLength;i++){
                        $(sources[i]).find(".add_del").find("a:eq(0)").hide();
                        if(i == sourcesLength){
                            $(sources[i]).find(".add_del").find("a:eq(0)").show();
                        }
                    }
                }
            }
            else{
                $(this).parent().parent().parent().append(insertStr);
                for(i=0;i<sourcesLength;i++){
                    $(sources[i]).find(".add_del").find("a:eq(0)").hide();
                    if(i == sourcesLength){
                        $(sources[i]).find(".add_del").find("a:eq(0)").show();
                    }
                }
            }

            $.each($('.datetimepicker'),function(i,data){
                $(data).datetimepicker({lang:'ch'});
            });
        }
        //点击每条删除直播源的行为
        else if(this.name == "minus-source"){

            var self = this;
            dialogDelSoure.dialog('open');
            dialogDelSoure.dialog('option', 'buttons', {
                '删除': function () {
                    var sources1 = $(self).parent().parent().parent().find("tr");
                    var sourcesLength1 = sources1.size();
                    if(sourcesLength1 == 1){
                        var tds = $(self).parent().parent().find("td").size();
                        $.each($(self).parent().parent().find("td"),function(i,data){
                            if(i<(tds-2)){
                                if(i == 0){
                                    $(data).find("i").text('');
                                    $(data).find("select").hide();
                                }
                                else if(i == 1){
                                    $(data).find("input").val("");
                                    $(data).find("input").hide();
                                    $(data).find("span").text("");
                                }
                                else{
                                    $(data).html('');
                                    $(data).html(strInsert);
                                }
                            }
                            else if(i==(tds-2)){
                                $(data).find("a:eq(1)").hide();
                            }
                            else if(i==(tds-1)){
                                $(data).find("a:eq(1)").hide();
                                $(data).find("a:eq(0)").hide();
                            }
                        });

                    }
                    else{
                        $(self).parent().parent().remove();
                        for(i=0;i<sourcesLength1-1;i++){
                            $(sources1[i]).find(".add_del").find("a:eq(0)").hide();
                            if(i == sourcesLength1-2){
                                $(sources1[i]).find(".add_del").find("a:eq(0)").show();
                            }
                        }
                    }

                    dialogDelSoure.dialog('close');
                    dialogSuc.dialog('open');
                    tip();
                },
                '取消': function () {
                    dialogDelSoure.dialog('close');
                }
            });

        }
        else if(this.name == "apply"){
//            $(this).text("直播已申请");
            dialogTip.dialog('open');
            $(".tip-info").text("此功能暂未开放");
        }
        else if(this.name == "release"){
            dialogTip.dialog('open');
            $(".tip-info").text("此功能暂未开放");
        }
        else if(this.name == "del-all"){
            var self = this;
            dialogDel.dialog('open');
            dialogDel.dialog('option', 'buttons', {
                '删除': function () {
//                    $.get("/channels/" + cid + '/delete', function () {
//                        $(self).parent().parent().remove();
//                        dialogDel.dialog('close');
//                        dialogSuc.dialog('open');
//                        tip();
//                    });
                    $(self).parent().parent().remove();
                    dialogDel.dialog('close');
                    dialogSuc.dialog('open');
                    tip();
                },
                '取消': function () {
                    dialogDel.dialog('close');
                }
            });

        }

    });

    var tipDiv = $("div[aria-describedby='tip']");
    function tip(){
        var mask = $(".ui-widget-overlay");
        setTimeout(function () {
            mask.animate({
                opacity: 0
            }, 500, function () {
                mask.css({"opacity": .8})
            });

            tipDiv.animate({
                opacity: 0
            }, 250, function () {
                dialogSuc.dialog('close');
                tipDiv.css({"opacity": 1})
            });
        }, 500)
    }

    new WidgetSlideshow({
        "defaultNums": 7,
        "id": "fixture_list",
        "edge": "true"
    });

</script>
</body>
</html>
